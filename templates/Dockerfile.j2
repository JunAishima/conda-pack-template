FROM {{ docker_image }} as build

ENV env_name="{{ env_name }}"
ENV python_version="{{ python_version }}"
ENV pkg_name="{% if pkg_name %}{{ pkg_name }}={{ pkg_version }}{% endif %}"
ENV extra_packages="{{ extra_packages }}"
ENV channels="{{ channels }}"
ENV conda_env_file="{{ conda_env_file }}"
ENV conda_binary="{{ conda_binary }}"
ENV HOME="/home/conda"

# RUN echo "always_yes: true\n\
# envs_dirs:\n\
#   - ~/conda_envs\n\
#   - /opt/conda_envs" >> /home/conda/.condarc

COPY export.sh ${HOME}/export.sh
COPY configs/${conda_env_file} ${HOME}/${conda_env_file}

{% if extra_cmd_before_install %}RUN {{ extra_cmd_before_install }} && yum clean all{{ "\n\n" }}{% endif -%}

RUN source /opt/conda/etc/profile.d/conda.sh && \
    conda install -y ${channels} conda mamba && \
    {{ conda_binary }} env create \
        --file=${HOME}/${conda_env_file} \
        -p /opt/conda_envs/${env_name}

{%- if extra_cmd_after_install %}{{ '\n' }}
RUN {{ conda_binary }} install -y --override-channels ${channels} -p /opt/conda_envs/${env_name} conda-pack ${extra_packages} && \
    {{ extra_cmd_after_install }} -p /opt/conda_envs/${env_name}{% endif %}

