FROM {{ docker_image }} as build

ENV env_name="{{ env_name }}"
ENV python_version="{{ python_version }}"
ENV pkg_name="{% if pkg_name %}{{ pkg_name }}={{ pkg_version }}{% endif %}"
ENV extra_packages="{{ extra_packages }}"
ENV channels="{{ channels }}"

RUN yum install curl mesa-libGL -y && yum clean all && \
    source /opt/conda/etc/profile.d/conda.sh && \
    conda install conda -y && \
    conda create -n ${env_name} ${channels} --override-channels -y python=${python_version} conda-pack ${pkg_name} ${extra_packages}

RUN bash -l -c "conda activate /opt/conda_envs/{{ env_name }} && conda remove perl --force -y || echo 'Perl not found'"

COPY export.sh /home/conda/
